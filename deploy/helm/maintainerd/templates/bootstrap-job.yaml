{{- if .Values.bootstrap.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: maintainerd-bootstrap
  annotations:
    argocd.argoproj.io/sync-wave: {{ .Values.bootstrap.syncWave | quote }}
spec:
  backoffLimit: 3
  template:
    spec:
      {{- if .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml .Values.imagePullSecrets | nindent 8 }}
      {{- end }}
      restartPolicy: OnFailure
      containers:
        - name: bootstrap
          image: {{ .Values.image.repository }}:{{ .Values.image.tag }}
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          command:
            - "/usr/local/bin/bootstrap"
            - "--seed"
            - "--db"
            - "{{ .Values.db.path }}"
          envFrom:
            - secretRef:
                name: {{ .Values.envFromSecret }}
          env:
            - name: WORKSPACE_CREDENTIALS_FILE
              value: /creds/credentials.json
          volumeMounts:
            - name: db
              mountPath: /data
            - name: creds
              mountPath: /creds
              readOnly: true
      volumes:
        - name: db
          persistentVolumeClaim:
            claimName: {{ .Values.pvc.name }}
        - name: creds
          secret:
            secretName: {{ .Values.credsSecret }}
{{- end }}
