apiVersion: batch/v1
kind: Job
metadata:
  name: maintainerd-bootstrap
  namespace: maintainerd
spec:
  backoffLimit: 0
  ttlSecondsAfterFinished: 1800
  template:
    spec:
      restartPolicy: Never
      serviceAccountName: maintainer-sync
      imagePullSecrets:
      - name: ghcr-secret
      containers:
      - name: bootstrap
        image: ghcr.io/robertkielty/maintainerd:latest
        imagePullPolicy: Always
        envFrom:
        - secretRef:
            name: maintainerd-db-env       # provides MD_DB_DRIVER, MD_DB_DSN or MD_DB_PATH
        - secretRef:
            name: maintainerd-bootstrap-env # provides spreadsheet-related env (SPREADSHEET_ID, creds, etc.)
        env:
        - name: PGPASSWORD
          valueFrom:
            secretKeyRef:
              name: maintainerd-db-env
              key: PGPASSWORD
        - name: GOOGLE_APPLICATION_CREDENTIALS
          value: /var/secrets/google/credentials.json
        command: ["/usr/local/bin/bootstrap"]
        volumeMounts:
        - name: gcloud-creds
          mountPath: /var/secrets/google
          readOnly: true
      volumes:
      - name: gcloud-creds
        secret:
          secretName: workspace-credentials
