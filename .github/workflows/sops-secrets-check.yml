name: SOPS Secrets Check

on:
  push:
    branches:
      - "**"
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

jobs:
  secrets-check:
    name: Encrypted secrets check
    runs-on: oracle-vm-2cpu-8gb-x86-64
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify deploy secrets are encrypted
        run: |
          set -euo pipefail
          files=$(ls deploy/secrets/*.y*ml 2>/dev/null || true)
          if [ -z "$files" ]; then
            echo "No deploy/secrets YAML files found. Skipping."
            exit 0
          fi
          fail=0
          for file in $files; do
            if ! grep -q '^sops:' "$file"; then
              echo "ERROR: $file is missing sops metadata."
              fail=1
              continue
            fi
            while IFS= read -r line; do
              [[ "$line" =~ ^[[:space:]]*# ]] && continue
              [[ "$line" =~ ^[[:space:]]*$ ]] && continue
              if [[ "$line" =~ ^[[:space:]]*([A-Za-z0-9_]*(TOKEN|SECRET|PASSWORD|KEY)[A-Za-z0-9_]*)[[:space:]]*:[[:space:]]*(.+)$ ]]; then
                value="${BASH_REMATCH[3]}"
                if [[ "$value" != ENC[* ]]; then
                  echo "ERROR: $file contains unencrypted value for ${BASH_REMATCH[1]}."
                  fail=1
                fi
              fi
            done < "$file"
          done
          if [ "$fail" -ne 0 ]; then
            echo "Encrypted secrets check failed."
            exit 1
          fi
